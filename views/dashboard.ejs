<!DOCTYPE html>
<html>
<head>
<title>Dashboard Cá Cảnh</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
input, button { padding: 8px; margin: 5px 0; width: 100%; }
canvas { max-width: 100%; }
#popup { position: fixed; bottom: 20px; right: 20px; background: #fffae6; border: 1px solid #ccc; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
</style>
</head>
<body>

<h2>📊 Biểu đồ nhiệt độ</h2>
<canvas id="tempChart" height="180"></canvas>

<h3>🎯 Điều chỉnh nhiệt độ</h3>
<form method="POST" action="/dashboard.php">
    <input type="number" step="0.1" name="targetTemp" value="<%= targetNow %>" required>
    <input type="number" step="0.1" name="minTemp" value="<%= minNow %>" required>
    <input type="number" step="0.1" name="maxTemp" value="<%= maxNow %>" required>
    <button type="submit">Cập nhật</button>
</form>
<p>Hiện tại: <b><%= minNow %>°C ~ <%= maxNow %>°C</b> | Mục tiêu: <b><%= targetNow %>°C</b></p>

<h4>📜 Lịch sử thay đổi cấu hình</h4>
<table>
<tr><th>Thời gian</th><th>Target</th><th>Min</th><th>Max</th></tr>
<% history.forEach(h => { %>
<tr>
  <td><%= h.time %></td>
  <td><%= h.target %></td>
  <td><%= h.min %></td>
  <td><%= h.max %></td>
</tr>
<% }) %>
</table>

<h3>🕒 Lịch cho ăn</h3>
<form method="POST" action="/dashboard.php">
    <input type="text" name="feedTime" placeholder="VD: 09:00,21:00" value="<%= feedNow %>" required>
    <button type="submit">Cập nhật</button>
</form>

<h3>📋 Lịch sử hoạt động</h3>
<table id="activityTable">
<tr><th>Thời gian</th><th>Nhiệt độ</th><th>Trạng thái</th></tr>
<% data.slice().reverse().forEach(row => { %>
<tr>
  <td><%= row.time %></td>
  <td><%= row.temp %></td>
  <td><%= row.status %></td>
</tr>
<% }) %>
</table>

<% if (popup) { %>
<div id="popup">🔔 <%= popup %></div>
<% } %>

<script>
// ====== Khởi tạo chart ban đầu ======
const ctx = document.getElementById('tempChart').getContext('2d');
let labels = <%- JSON.stringify(data.slice(-20).map(d => d.time)) %>;
let temps  = <%- JSON.stringify(data.slice(-20).map(d => d.temp)) %>;

const tempChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Nhiệt độ (°C)',
            data: temps,
            borderColor: 'red',
            fill: false,
            tension: 0.1,
            pointRadius: 2
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
            x: { ticks: { maxRotation: 90, minRotation: 45, autoSkip: true } },
            y: { min: 0, max: 50, beginAtZero: true }
        }
    }
});

// ====== Hàm cập nhật chart từ API ======
async function updateChart() {
    try {
        const res = await fetch('/api/data/latest');
        const json = await res.json();
        if (Array.isArray(json)) {
            const newLabels = json.map(d => d.time);
            const newTemps  = json.map(d => d.temp);
            tempChart.data.labels = newLabels;
            tempChart.data.datasets[0].data = newTemps;
            tempChart.update();

            // Cập nhật bảng lịch sử hoạt động
            const tbody = document.getElementById("activityTable");
            tbody.innerHTML = "<tr><th>Thời gian</th><th>Nhiệt độ</th><th>Trạng thái</th></tr>";
            json.slice().reverse().forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${row.time}</td><td>${row.temp}</td><td>${row.status}</td>`;
                tbody.appendChild(tr);
            });
        }
    } catch (e) {
        console.error("Lỗi cập nhật biểu đồ:", e);
    }
}

// ====== Hàm cập nhật popup ======
async function updatePopup() {
    try {
        const res = await fetch('/api/status/latest');
        const json = await res.json();
        if (json && json.status) {
            let popupEl = document.getElementById("popup");
            if (!popupEl) {
                popupEl = document.createElement("div");
                popupEl.id = "popup";
                document.body.appendChild(popupEl);
            }
            popupEl.textContent = `🔔 ${json.status} lúc ${json.time}`;
        }
    } catch (e) {
        console.error("Lỗi cập nhật popup:", e);
    }
}

// ====== Tự động refresh mỗi 1 giây ======
setInterval(() => {
    updateChart();
    updatePopup();
}, 1000);
</script>

</body>
</html>
