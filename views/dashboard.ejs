<!DOCTYPE html>
<html>
<head>
<title>Dashboard CÃ¡ Cáº£nh</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
input, button { padding: 8px; margin: 5px 0; width: 100%; }
canvas { max-width: 100%; }
#popup { position: fixed; bottom: 20px; right: 20px; background: #fffae6; border: 1px solid #ccc; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
</style>
</head>
<body>

<h2>ğŸ“Š Biá»ƒu Ä‘á»“ nhiá»‡t Ä‘á»™</h2>
<canvas id="tempChart" height="180"></canvas>

<h3>ğŸ¯ Äiá»u chá»‰nh nhiá»‡t Ä‘á»™</h3>
<form method="POST" action="/dashboard.php">
    <input type="number" step="0.1" name="targetTemp" value="<%= targetNow %>" required>
    <input type="number" step="0.1" name="minTemp" value="<%= minNow %>" required>
    <input type="number" step="0.1" name="maxTemp" value="<%= maxNow %>" required>
    <button type="submit">Cáº­p nháº­t</button>
</form>
<p>Hiá»‡n táº¡i: <b><%= minNow %>Â°C ~ <%= maxNow %>Â°C</b> | Má»¥c tiÃªu: <b><%= targetNow %>Â°C</b></p>

<h4>ğŸ“œ Lá»‹ch sá»­ thay Ä‘á»•i cáº¥u hÃ¬nh</h4>
<table>
<tr><th>Thá»i gian</th><th>Target</th><th>Min</th><th>Max</th></tr>
<% history.forEach(h => { %>
<tr>
  <td><%= h.time %></td>
  <td><%= h.target %></td>
  <td><%= h.min %></td>
  <td><%= h.max %></td>
</tr>
<% }) %>
</table>

<h3>ğŸ•’ Lá»‹ch cho Äƒn</h3>
<form method="POST" action="/dashboard.php">
    <input type="text" name="feedTime" placeholder="VD: 09:00,21:00" value="<%= feedNow %>" required>
    <button type="submit">Cáº­p nháº­t</button>
</form>

<h3>ğŸ“‹ Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng</h3>
<table id="activityTable">
<tr><th>Thá»i gian</th><th>Nhiá»‡t Ä‘á»™</th><th>Tráº¡ng thÃ¡i</th></tr>
<% data.slice().reverse().forEach(row => { %>
<tr>
  <td><%= row.time %></td>
  <td><%= row.temp %></td>
  <td><%= row.status %></td>
</tr>
<% }) %>
</table>

<% if (popup) { %>
<div id="popup">ğŸ”” <%= popup %></div>
<% } %>

<script>
// ====== Khá»Ÿi táº¡o chart ban Ä‘áº§u ======
const ctx = document.getElementById('tempChart').getContext('2d');
let labels = <%- JSON.stringify(data.slice(-20).map(d => d.time)) %>;
let temps  = <%- JSON.stringify(data.slice(-20).map(d => d.temp)) %>;

const tempChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Nhiá»‡t Ä‘á»™ (Â°C)',
            data: temps,
            borderColor: 'red',
            fill: false,
            tension: 0.1,
            pointRadius: 2
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
            x: { ticks: { maxRotation: 90, minRotation: 45, autoSkip: true } },
            y: { min: 0, max: 50, beginAtZero: true }
        }
    }
});

// ====== HÃ m cáº­p nháº­t chart tá»« API ======
async function updateChart() {
    try {
        const res = await fetch('/api/data/latest');
        const json = await res.json();
        if (Array.isArray(json)) {
            const newLabels = json.map(d => d.time);
            const newTemps  = json.map(d => d.temp);
            tempChart.data.labels = newLabels;
            tempChart.data.datasets[0].data = newTemps;
            tempChart.update();

            // Cáº­p nháº­t báº£ng lá»‹ch sá»­ hoáº¡t Ä‘á»™ng
            const tbody = document.getElementById("activityTable");
            tbody.innerHTML = "<tr><th>Thá»i gian</th><th>Nhiá»‡t Ä‘á»™</th><th>Tráº¡ng thÃ¡i</th></tr>";
            json.slice().reverse().forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${row.time}</td><td>${row.temp}</td><td>${row.status}</td>`;
                tbody.appendChild(tr);
            });
        }
    } catch (e) {
        console.error("Lá»—i cáº­p nháº­t biá»ƒu Ä‘á»“:", e);
    }
}

// ====== HÃ m cáº­p nháº­t popup ======
async function updatePopup() {
    try {
        const res = await fetch('/api/status/latest');
        const json = await res.json();
        if (json && json.status) {
            let popupEl = document.getElementById("popup");
            if (!popupEl) {
                popupEl = document.createElement("div");
                popupEl.id = "popup";
                document.body.appendChild(popupEl);
            }
            popupEl.textContent = `ğŸ”” ${json.status} lÃºc ${json.time}`;
        }
    } catch (e) {
        console.error("Lá»—i cáº­p nháº­t popup:", e);
    }
}

// ====== Tá»± Ä‘á»™ng refresh má»—i 1 giÃ¢y ======
setInterval(() => {
    updateChart();
    updatePopup();
}, 1000);
</script>

</body>
</html>
